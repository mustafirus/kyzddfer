
# мануаль по опису пов'язаних рекордів у "ky-format" (.ky)

**Версія:** 1.2
**Статус:** Рекомендовано до використання

## 1\. Концепція та Призначення

**`ky-format`** — це гнучка, декларативна мова для опису метаданих систем. Вона використовує текстовий формат з ієрархічною структурою, заснованою на відступах, для опису складних програмних сутностей, таких як схеми баз даних (`tables`) та модульні додатки з їхніми лейаутами (`apps`). Ключова особливість формату — синтаксис визначення елемента залежить від контексту (секції), в якому він знаходиться.

## 2\. Базовий Синтаксис

  * **Розширення файлу:** `.ky`
  * **Кодування:** `UTF-8`
  * **Коментарі:** Будь-який текст після символу `#` і до кінця рядка вважається коментарем та ігнорується.
  * **Ієрархія та Відступи:** Структура документу визначається відступами. Кожен рівень вкладеності — це **рівно 2 пробіли**.
  * **Кореневий елемент:** Кожен `.ky` файл повинен починатися з кореневого елемента `rack`, який обов'язково має атрибут версії, наприклад `ver(1.0)`.
  * **Структура секцій:** Всередині `rack` повинні бути присутні дві секції у строгому порядку: спочатку `tables`, а потім `apps`.
  * **Неявне поле `id`:** В `ky-format` не потрібно визначати поле `id` для таблиць. Фреймворк створює його в SQL самостійно як `id serial primary key`.

## 3\. Визначення Сутностей

### 3.1. Визначення Таблиці (у секції `tables`)

Таблиця визначається своїм іменем та необов'язковими прапорами й атрибутами.

  * **Синтаксис:**
    ```text
    <tablename> [!flags] [attributes]
    ```

### 3.2. Визначення Поля (всередині таблиці)

Поле завжди має ім'я та тип, а також необов'язкові прапори й атрибути.

  * **Синтаксис:**
    ```text
    <fieldname> type [!flags] [attributes]
    ```
  * **Правило:** Поля всередині форми (`form`) обов'язково мають бути згруповані у контейнери, наприклад `fieldbox`.

### 3.3. Визначення Лейауту (у секції `apps`)

Визначення лейауту складається з двох послідовних частин, що знаходяться **на одному рівні вкладеності**:

1.  **Рядок метаданих:** Визначає назву (`<layoutname>`) та атрибути для вибору лейауту (напр., `title`, `media`, `usage`).
2.  **Рядок кореневого вузла:** Описує кореневий вузол (`<root>`), наприклад `list` або `form`, та його дочірні елементи.

<!-- end list -->

  * **Приклад:**
    ```ky
    apps
      project_tracker
        # Рядок метаданих (3 відступи)
        projects_view title("Список проєктів")
        
        # Рядок з кореневим вузлом (list) на тому ж рівні (3 відступи)
        list table(projects)
          name
          manager
    ```

## 4\. Патерни Лейаутів та Взаємодія

### 4.1. Форма з дочірнім списком (Один-до-багатьох)

**Приклад:** Форма редагування документа та список його рядків.

**Рішення:** Дочірній `list` вкладається безпосередньо у батьківський `form`. Зв'язок може встановлюватися **явно** або **неявно**.
Атрібут link(<ref>:<id|ref2>) - де ref поле ref дочірнього `list`, id - поле id, ref2 - поле ref батьківського `form`
якщо використовується поле id - його можна не вказувати(дефолт)
якщо ref співпадає з назвою таблиці - його можна не вказувати(дефолт)

```ky
# Схема
tables
  document
    title varchar(255)
  document_line
    document ref(document)
    line_number int
    line_text text

# Лейаут
form table(document)
  fieldbox
    title
  
  # Цей список автоматично буде відфільтровано за document_id={id}
  # батьківського запису 'document'.
  # list table(document_line) link(document:id) title("Рядки документа")
  # або спрощено
  list table(document_line) title("Рядки документа")
    name
```

### 4.2. Master-Detail (Список та Деталі)

**Приклад:** Зліва список авторів, справа — форма з деталями про вибраного автора.

**Рішення:** Для візуального розташування використовуються контейнерні вузли (`hbox`, `vbox`). Логічний зв'язок встановлюється через вкладеність: дочірній елемент (`form`) є логічною частиною батьківського (`list`), а атрибут `placement` керує його візуальним розташуванням.

```ky
# Лейаут
list table(author)
  # Колонки списку (master)
  full_name

  # Форма є ЛОГІЧНИМ дочірнім елементом списку.
  # Атрибут `placement(right)` вказує, що візуально 
  # її треба розмістити справа від списку.
  form placement(right)
    # Поля форми (detail)
    fieldbox
      full_name
      birth_date
      biography
```

### 4.3. Вибір значення для зовнішнього ключа (Lookup)

**Приклад:** На формі редагування книги потрібно вибрати автора зі списку.

**Рішення:** Цей зв'язок реалізується на рівні логіки програми. Поле типу `ref` (наприклад, `author ref(author)`) автоматично отримує можливість ініціювати відкриття іншого лейауту (`usage(select)`) для вибору значення. У `.ky` файлі це не вимагає спеціального синтаксису, крім визначення самого поля.

```ky
# Форма редагування
form table(book)
  fieldbox
    title
    # UI-елемент для цього поля буде кнопкою або посиланням,
    # що відкриває список вибору авторів.
    author

# Окремий лейаут, що використовується для вибору
author_selection_list usage(select)
  list table(author)
    full_name
```

## 5\. Заплановане вдосконалення: Компонент `<listform>`

**Статус:** Ідея задокументована для майбутньої реалізації.

Цей компонент призначений для створення складних екранів, що поєднують в собі список і деталізовану інформацію як єдине ціле.

**Ідея:** `listform` — це єдиний компонент, що інкапсулює і список (master), і секцію деталей (detail). Його дочірні елементи автоматично інтерпретуються або як колонки списку, або як частина панелі деталей, залежно від їхнього типу та контексту.

### Приклад концепту

```ky
listform table(author)
  # Контейнер для візуального розташування
  hbox
    # Цей fieldbox буде інтерпретовано як визначення колонок
    # для master-списку авторів.
    fieldbox
      full_name

    # Цей vbox буде інтерпретовано як панель деталей
    # для вибраного автора.
    vbox      
      # Форма з деталями вибраного автора
      form table(author)
        fieldbox
          full_name
          birth_date
          biography
      
      # Список книг вибраного автора
      list table(book)
        fieldbox
          title
          genre
          publication_year
```
