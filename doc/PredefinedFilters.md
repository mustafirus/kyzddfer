# План реалізації "Predefined Filters"

Цей документ описує зміни, необхідні для реалізації механізму готових, визначених розробником фільтрів. Архітектура розділяє визначення фільтрів, їх системне застосування та інтерактивну активацію користувачем.

-----

## 1\. Зміни у форматі `.ky`

### 1.1. Визначення фільтрів

Вводиться нова необов'язкова підсекція `filters` у визначення `table`. Вона слугує для опису фільтрів, що логічно пов'язані з даною таблицею.
у форматі:
    filters
      <filtername>: ($field <op> {value}) & | ! ...
      .........


**Приклад:**

```ky
tables
  tasks
    # ... визначення полів ...
    
    filters
      archived: $status = {archived}
      high_priority: $priority = {High}
```

### 1.2. Застосування фільтрів у лейаутах

Вводяться два нові атрибути для вузлів `list`.

1.  **`show_filters(...)`**: Для відображення тільки деяких фільтрів в UI як "галочки", яку користувач може вмикати/вимикати.
2.  **`hide_filters(...)`**: Для відображення всіх доступних для таблиці крім вказаних.

**Приклад:**

```ky
apps
  task_manager
    project_details
    form table(projects) # Фільтрується по id
      # Список завдань, системно відфільтрований по поточному проєкту
      # і з можливістю для юзера увімкнути/вимкнути фільтр "Архівні"
      list table(tasks) show_filters(archived)
```

-----

## 2\. Зміни у протоколі `ky.proto`

### 2.1. Нова RPC дія для активації фільтрів

Для обробки ввімкнення/вимкнення "галочки" користувачем, до сервісу `RecordsetManager` додається новий RPC-виклик.

**Доповнення до `ky.proto`:**

```proto
service RecordsetManager {
  // ... існуючі rpc ...
  rpc TogglePredefinedFilter(PredefinedFilterToggle) returns (Recordset) {}
}

message PredefinedFilterToggle {
  Id32 rec_id = 1;
  string name = 2; // Назва готового фільтра, напр. "archived"
  bool is_on = 3;  // Новий стан "галочки"
}
```

### 2.2. Оновлення відповіді сервера

Щоб клієнт знав, які "галочки" наразі активні, відповідь `Recordset` доповнюється новим полем.

**Доповнення до `ky.proto`:**

```proto
message Recordset {
  // ... існуючі поля ...
  // НОВЕ ПОЛЕ: список імен увімкнених "галочок"
  repeated string active_predefined_filters = 11;
}
```

-----

## 3\. Зміни на сервері (фреймворк)

1.  **Парсер `.ky`:** Оновити парсер для розпізнавання секції `filters` всередині таблиць.
2.  **Сховище фільтрів:** Реалізувати зберігання визначень фільтрів (напр., у словнику в об'єкті `Table`).
4.  **Обробник RPC:** Створити логіку для нового методу `TogglePredefinedFilter`, який модифікує стан фільтрів для сесії користувача.
5.  **Формування відповіді:** Забезпечити заповнення нового поля `active_predefined_filters` в об'єкті `Recordset` перед відправкою клієнту.