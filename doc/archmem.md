# Архітектурний Меморандум: Проектування 3-рівневої Системи

**Мета:** Спроектувати сучасну, гнучку та масштабовану 3-рівневу архітектуру (Клієнт -> Middleware -> СУБД), яка успадковує надійні та перевірені часом принципи з 2-рівневої системи `kino` (1995), вирішуючи при цьому проблему "спагеті-коду" та забезпечуючи централізацію бізнес-логіки.

---

### 1. Розподіл Відповідальності: "Менеджер" та "Компонент"

Щоб уникнути хаосу та "розмазування" логіки, ми домовились про чіткий розподіл ролей між двома ключовими сутностями на середньому рівні (middleware).

#### `Session` — Менеджер Навігації

* **Основна функція:** `Session` відповідає **виключно за навігацію** та керування життєвим циклом представлень (`View`).
* **Зберігач контексту:** Він володіє стеком активних представлень `std::vector<View*> view_stack`, що є прямим ідеологічним наступником `FrameThread` з архітектури `kino`. Цей стек є логічним ланцюжком шляху користувача.
* **Диспетчер дій:** `Session` приймає від клієнта стандартизовані **Дії (Actions)** і виступає як диспетчер, що викликає створення, знищення або переключення `View`.
* **Відповідає на питання:** *«Що і коли показати?»*

#### `View` — Розумний Компонент

* **Основна функція:** `View` — це самодостатній, активний компонент, який **робить всю "брудну" (розумну) роботу**, пов'язану з конкретним екраном (формою, списком).
* **Власник стану:** Він володіє своїми даними часу виконання (`RecordsetParams`, `RecordParams`) і сам керує ними: завантажує, сортує, фільтрує, перевіряє та зберігає.
* **Центр логіки:** Вся бізнес-логіка, що стосується одного представлення, інкапсульована всередині відповідного об'єкта `View`.
* **Генератор дій:** На основі метаданих та поточного стану `View` генерує список можливих **Дій** для клієнта.
* **Відповідає на питання:** *«Як я поводжуся і що роблю зі своїми даними?»*

---

### 2. Архітектура Рівнів

Ми переносимо всю логіку з "товстого" клієнта на середній рівень.

* **Рівень 1: Тонкий Клієнт**
    * **"Тупий" рендерер:** Єдине завдання — відобразити опис інтерфейсу (`Frame`), отриманий від сервера.
    * **Виконавець дій:** Не має власної логіки. При взаємодії з користувачем просто відправляє ідентифікатор відповідної **Дії** назад на сервер.

* **Рівень 2: Middleware (gRPC Сервер)**
    * **Серце системи:** Тут живе вся бізнес-логіка, успадкована з `kino`.
    * Тут працюють `Session`, `View` та диспетчер **Дій**.
    * Цей рівень є єдиним, хто має прямий доступ до бази даних.

* **Рівень 3: СУБД**
    * Залишається сховищем даних без змін у своїй ролі.

---

### 3. Декларативність та Керування Діями (Actions)

* **Data-Driven:** Поведінка системи керується декларативними метаданими з файлів `.ky`. Структура таблиць, зв'язків та представлень (`layout`) визначає роботу додатку.
* **Декларативні Дії:** Замість жорсткого кодування логіки в обробниках подій, сервер наперед прораховує всі можливі **Дії** для кожного елемента `View`. Клієнт лише відправляє обрану **Дію**, а `Session` її централізовано виконує. Це повністю вирішує проблему навігації у складних сценаріях (перехід за посиланням, вибір значення зі списку, повернення назад із оновленням попереднього `View`).

**Підсумок:** Ця архітектура зберігає перевірені часом принципи централізації та керованості даними, успішно переносячи їх у сучасну, безпечну та гнучку 3-рівневу модель. Ваше відчуття виявилося абсолютно правильним: **`Session` тримає стек, а `View` виконує всю розумну роботу.**