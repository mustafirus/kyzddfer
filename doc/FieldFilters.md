# План реалізації "Field Filters"

Цей документ описує реалізацію динамічних фільтрів, які кінцевий користувач застосовує через інтерфейс. Ключовими принципами є швидкість, інтуїтивність та пріоритет на роботі з клавіатури.

-----

## 1\. Користувацький інтерфейс (UI) та взаємодія

Основний елемент для фільтрації — це поле вводу в заголовку колонки таблиці. Для зручної роботи з кількома `OR`-умовами використовується модель "тегів у полі вводу".

  * **Введення:** Користувач вводить значення (`Київ`) і натискає `Enter`. Текст перетворюється на тег `[ Київ ⓧ ]`. Курсор залишається в полі, готовий до наступного вводу.
  * **Навігація:** Стрілки `←` та `→` дозволяють переміщатися між створеними тегами, виділяючи активний.
  * **Видалення:**
      * Натискання `Backspace` в порожньому полі виділяє останній тег. Повторне натискання — видаляє його.
      * Натискання `Delete` видаляє будь-який виділений тег.
  * **Редагування:** Натискання `Enter` на виділеному тезі перетворює його назад на текстове поле для редагування.

-----

## 2\. Синтаксис фільтрів (DSL)

Використовується простий текстовий синтаксис, де оператор кодується всередині значення.

  * **Оператори порівняння:**
      * **За замовчуванням:** `текст` (означає `=` або `LIKE`).
      * **Префікси:** `>1000`, `<50`, `!=активний`, `~регексп`.
      * **Діапазон:** `10:20` (означає `BETWEEN 10 AND 20`).
  * **Логіка `АБО` (`OR`):**
      * Кілька умов для одного поля поєднуються через роздільник `|`.
      * **Приклад:** Пошук за ціною в діапазоні 10-20 або більше 100: `10:20|>100`.
      * В UI це буде виглядати як два окремі теги: `[ 10:20 ⓧ ]` та `[ >100 ⓧ ]`. "Під капотом" вони об'єднуються в один рядок для відправки на сервер.

-----

## 3\. Клієнт-серверна взаємодія (протокол)

Для встановлення та оновлення динамічних фільтрів використовується існуючий RPC-виклик з файлу `ky.proto.txt`.

  * **Дія:** Клієнт викликає `rpc SetFilter(SetFilterReq) returns (Recordset)` (Назву повідомлення виправлено).
  * **Повідомлення:** У тілі `SetFilterReq` надсилається `Recordset.Filter` .
      * `name`: Назва поля, до якого застосовується фільтр (напр., "status").
      * `val`: Рядок, що містить значення та оператори згідно з синтаксисом DSL (напр., `"new|in_progress"`).

**Приклад:** Користувач ввів `>1000` у фільтр для поля `amount`. Клієнт надсилає:

```proto
filter: { name: "amount", val: ">1000" }
```

-----

## 4\. Логіка на сервері (фреймворк)

1.  **Отримання дії:** Сервер приймає виклик `SetFilter`.
2.  **Парсинг `val`:** Сервер розбирає рядок `val`, визначаючи оператори та значення.
3.  **Оновлення стану:** Модифікує стан фільтрів для поточної сесії користувача.
4.  **Побудова запиту:** Поєднує користувацькі фільтри з системними та предефайнед фільтрами через `AND`.
5.  **Обробка помилок:** У випадку некоректного синтаксису в `val`, парсер повертає помилку, яка надсилається клієнту для відображення.
